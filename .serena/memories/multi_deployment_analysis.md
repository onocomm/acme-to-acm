# Multi-Deployment Analysis for ACME to ACM CDK Project

## Analysis Complete: Multiple Deployments ARE Possible with Modifications

### Current State Summary
The project can technically be deployed multiple times, but with significant hardcoded resource names that would cause conflicts.

---

## 1. HARDCODED RESOURCE NAMES

### Lambda Function Name
- **Location**: `/Users/yonoyama/works/acme-to-acm/lib/constructs/certificate-lambda.ts:80`
- **Current Value**: `'AcmeToAcmCertificateRenewer'` (HARDCODED - line 80)
- **Impact**: Only ONE Lambda function can exist per AWS account with this name
- **Conflict Type**: CRITICAL - Second deployment would fail or overwrite

### SNS Topic Name
- **Location**: `/Users/yonoyama/works/acme-to-acm/lib/constructs/notification.ts:52`
- **Current Value**: `'AcmeToAcmNotifications'` (HARDCODED - line 52)
- **Impact**: Only ONE SNS topic can exist per region with this name
- **Conflict Type**: CRITICAL - Second deployment would fail or overwrite

### EventBridge Rule Name
- **Location**: `/Users/yonoyama/works/acme-to-acm/lib/constructs/certificate-lambda.ts:199`
- **Current Value**: `'AcmeToAcmWeeklyCheck'` (HARDCODED - line 199)
- **Impact**: Only ONE EventBridge rule can exist per account with this name
- **Conflict Type**: CRITICAL - Second deployment would fail or overwrite

### S3 Bucket Name
- **Location**: `/Users/yonoyama/works/acme-to-acm/lib/constructs/storage.ts:55`
- **Pattern**: `acme-to-acm-certificates-${account}${suffix || ''}`
- **Current Value**: `acme-to-acm-certificates-{ACCOUNT_ID}` (uses account ID for uniqueness)
- **Impact**: Supports ONE bucket per account + optional suffix parameter
- **Flexibility**: GOOD - Has bucketNameSuffix prop to support multiple buckets
- **Conflict Type**: NO CONFLICT if suffix is provided

### CloudFormation Stack Name
- **Location**: `/Users/yonoyama/works/acme-to-acm/bin/acme-to-acm.ts:22`
- **Current Value**: `'AcmeToAcmStack'` (HARDCODED - line 22)
- **Impact**: Only ONE stack with this name can be deployed per account per region
- **Conflict Type**: CRITICAL - Second deployment would fail or update existing stack

### CloudFormation Outputs
- **Exported Names** (lines 88, 92, 113, 119 in constructs):
  - `'AcmeToAcmBucketName'`
  - `'AcmeToAcmBucketArn'`
  - `'AcmeToAcmFunctionArn'`
  - `'AcmeToAcmFunctionName'`
- **Impact**: Cannot export multiple stacks with same names (per region/account)
- **Conflict Type**: MEDIUM - Export name collision

### CloudWatch Logs Group
- **Auto-generated by Lambda** based on function name
- **Pattern**: `/aws/lambda/{FunctionName}`
- **Current Value**: `/aws/lambda/AcmeToAcmCertificateRenewer`
- **Conflict Type**: NO CONFLICT (auto-generated from function name)

---

## 2. CONFIGURATION MECHANISMS

### Stack-Level Props (AcmeToAcmStackProps)
**File**: `lib/acme-to-acm-stack.ts:25-52`
**Currently Configurable**:
- `notificationEmail` (NOT USED - optional)
- `domainConfigKey` (default: 'config/domains.json')
- `scheduleExpression` (default: 'cron(0 17 ? * SUN *)')
- `enableSchedule` (default: true)

**NOT Currently Configurable**:
- Stack name (hardcoded in bin file)
- Lambda function name
- SNS topic name
- EventBridge rule name

### Lambda Environment Variables
**Passed from CDK** (`certificate-lambda.ts:93-98`):
- `CERTIFICATE_BUCKET`: Dynamic (from storage prop)
- `SNS_TOPIC_ARN`: Dynamic (from notification prop)
- `DOMAIN_CONFIG_KEY`: Configurable
- `CERTBOT_DIR`: Hardcoded ('/tmp/certbot')

### S3 Bucket Suffix Parameter
**File**: `storage.ts:33` (bucketNameSuffix prop)
**Current Implementation**: Accepts optional suffix
**Example Usage**: 
- JPRS: `acme-to-acm-certificates-{ACCOUNT_ID}-jprs`
- Let's Encrypt: `acme-to-acm-certificates-{ACCOUNT_ID}-letsencrypt`

---

## 3. DEPLOYMENT DEPENDENCIES

### Shared Certbot Account State
**Critical Finding**: All certificates from the SAME stack share ONE ACME account stored in S3

**How It Works**:
1. Lambda downloads Certbot config from S3 (`certbot/` folder)
2. First time: Empty directory, new ACME account registered (register mode)
3. Subsequent runs: Reuses same ACME account from S3
4. Multiple stacks = Multiple separate ACME accounts (because separate S3 buckets)

**Implication for Multi-Deployment**:
- Each deployment should have its own S3 bucket with separate ACME account
- Cannot use single S3 bucket for multiple ACME accounts (Certbot stores one account per config dir)
- HOWEVER: domains.json COULD be shared across stacks (but not recommended)

---

## 4. CURRENT LIMITATIONS

### Region Lock
- **Requirement**: `us-east-1` ONLY (CloudFront certificate requirement)
- **Impact**: Cannot deploy to other regions
- **Status**: Not configurable in CDK

### Single Account Scope
- **Design**: Each CDK stack = single ACME account in S3
- **Limitation**: Cannot manage multiple ACME providers per stack
- **Workaround**: Create separate stacks with different buckets

### S3 Bucket Per Stack
- **Current Design**: One bucket per stack (via bucketNameSuffix)
- **Benefit**: Isolates ACME account state
- **Limitation**: domains.json not shared between stacks

---

## 5. WHAT CAN CURRENTLY BE DEPLOYED MULTIPLE TIMES

### YES - Multiple S3 Buckets (with suffix parameter)
```
Stack 1: AcmeToAcmStack (suffix: "-jprs")
  -> Bucket: acme-to-acm-certificates-{ID}-jprs
  -> Lambda: AcmeToAcmCertificateRenewer (CONFLICT!)
  -> SNS Topic: AcmeToAcmNotifications (CONFLICT!)

Stack 2: AcmeToAcmStack (suffix: "-letsencrypt")
  -> Bucket: acme-to-acm-certificates-{ID}-letsencrypt
  -> Lambda: AcmeToAcmCertificateRenewer (CONFLICT!)
  -> SNS Topic: AcmeToAcmNotifications (CONFLICT!)
```

**Result**: Second deployment would OVERWRITE first Lambda and SNS!

---

## 6. REQUIRED CHANGES FOR TRUE MULTI-DEPLOYMENT

### Change 1: Parameterize Stack Name
**File**: `bin/acme-to-acm.ts:22`
**Current**: 
```typescript
new AcmeToAcmStack(app, 'AcmeToAcmStack', {
```
**Should Be**:
```typescript
const stackSuffix = process.env.STACK_SUFFIX || '';
new AcmeToAcmStack(app, `AcmeToAcmStack${stackSuffix}`, {
```

### Change 2: Parameterize Lambda Function Name
**File**: `certificate-lambda.ts:80`
**Current**:
```typescript
functionName: 'AcmeToAcmCertificateRenewer',
```
**Should Be**:
```typescript
functionName: `AcmeToAcmCertificateRenewer${suffix || ''}`,
```
(Add `suffix` parameter to CertificateLambdaProps)

### Change 3: Parameterize SNS Topic Name
**File**: `notification.ts:52`
**Current**:
```typescript
topicName: 'AcmeToAcmNotifications',
```
**Should Be**:
```typescript
topicName: `AcmeToAcmNotifications${suffix || ''}`,
```
(Add `suffix` parameter to CertificateNotificationProps)

### Change 4: Parameterize EventBridge Rule Name
**File**: `certificate-lambda.ts:199`
**Current**:
```typescript
ruleName: 'AcmeToAcmWeeklyCheck',
```
**Should Be**:
```typescript
ruleName: `AcmeToAcmWeeklyCheck${suffix || ''}`,
```

### Change 5: Make Exports Unique
**Files**: All construct outputs using `exportName`
**Current**: Fixed export names like `'AcmeToAcmBucketName'`
**Should Be**: `'AcmeToAcmBucketName-{suffix}'` or remove exports

---

## 7. RECOMMENDED DEPLOYMENT STRATEGY

### Option A: Environment Variable Approach (Recommended)
```bash
# Deploy for JPRS
export STACK_SUFFIX="-jprs"
npm run deploy

# Deploy for Let's Encrypt
export STACK_SUFFIX="-letsencrypt"
npm run deploy
```

### Option B: CDK Context Parameter Approach
```bash
# Deploy for JPRS
cdk deploy -c stackSuffix=-jprs

# Deploy for Let's Encrypt
cdk deploy -c stackSuffix=-letsencrypt
```

### Option C: CDK Context in cdk.json
```json
{
  "context": {
    "stackConfigurations": [
      {
        "name": "jprs",
        "suffix": "-jprs",
        "schedule": "cron(0 17 ? * SUN *)"
      },
      {
        "name": "letsencrypt",
        "suffix": "-letsencrypt",
        "schedule": "cron(0 18 ? * SUN *)"
      }
    ]
  }
}
```

---

## 8. CERTBOT ACCOUNT ISOLATION

### Current State
- **One ACME account per S3 bucket**
- Each bucket stores Certbot config in `certbot/` folder
- Account info persists across Lambda invocations

### Multiple Deployments Impact
- Stack 1 registers account to `s3://acme-to-acm-certificates-{ID}-jprs/certbot/`
- Stack 2 registers account to `s3://acme-to-acm-certificates-{ID}-letsencrypt/certbot/`
- **NO CONFLICT** - Each has separate account state

### Benefits of Separation
- Different ACME providers per stack (JPRS vs Let's Encrypt)
- Independent certificate renewal schedules
- Isolated credentials and account info

---

## 9. SHARED vs ISOLATED CONFIGURATION

### Currently Shared (CAN BE)
- `domains.json` could be in shared S3 location
- Lambda reads from `DOMAIN_CONFIG_KEY` env var
- **Problem**: All stacks would share same certificate config

### Currently Isolated (MUST BE)
- Certbot account state (per bucket)
- Lambda function (per stack)
- SNS topic (per stack)
- EventBridge rule (per stack)

### Recommended Architecture
```
S3 Bucket (JPRS):
  ├── certbot/                          (JPRS account state)
  ├── config/domains-jprs.json         (JPRS certificates only)
  └── certificates/                    (JPRS backups)

S3 Bucket (Let's Encrypt):
  ├── certbot/                          (Let's Encrypt account state)
  ├── config/domains-letsencrypt.json  (Let's Encrypt certificates only)
  └── certificates/                    (Let's Encrypt backups)
```

---

## 10. SUMMARY TABLE

| Resource | Current | Multi-Deploy Capable | Changes Needed |
|----------|---------|---------------------|-----------------|
| Stack Name | AcmeToAcmStack | NO | Parameterize |
| Lambda Function Name | AcmeToAcmCertificateRenewer | NO | Parameterize |
| SNS Topic Name | AcmeToAcmNotifications | NO | Parameterize |
| EventBridge Rule Name | AcmeToAcmWeeklyCheck | NO | Parameterize |
| S3 Bucket Name | With suffix support | YES* | Already supported |
| CloudFormation Exports | Fixed names | NO | Remove or parameterize |
| Certbot Account | Per bucket | YES | No changes needed |
| domains.json Key | Configurable | YES | No changes needed |
| Schedule Expression | Configurable | YES | No changes needed |
| Region | Hardcoded us-east-1 | NO | Not needed for multi-deploy |

*Only works if other resources are also parameterized

---

## 11. ESTIMATED EFFORT

### Minimal Changes (Allow 2 deployments)
- Parameterize 4 resource names (Lambda, SNS, EventBridge, Stack)
- ~30-45 minutes
- Files to modify: bin/acme-to-acm.ts (1), certificate-lambda.ts (2), notification.ts (1), acme-to-acm-stack.ts (1)

### Complete Solution (N deployments)
- Add configuration system (CDK context or environment variables)
- Parameterize all names via single parameter
- Update documentation with multi-deployment examples
- ~2-3 hours

### Testing
- Test deploying 2 stacks simultaneously
- Verify Lambda functions don't overwrite each other
- Verify SNS topics are separate
- Verify S3 buckets are separate with different ACME accounts
- Verify EventBridge rules trigger correct Lambda
- ~1 hour
